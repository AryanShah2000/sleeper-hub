<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Fantasy Agent</title>
<style>
  :root{
    --bg:#0b1020; --panel:#121a35; --muted:#6b7aa6; --text:#e8ecff; --accent:#5ee0ff; --accent2:#84ffb5; --warn:#ffd166;
    --border: rgba(255,255,255,0.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1f 60%);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px;border-bottom:1px solid var(--border);background:rgba(11,16,32,.9);backdrop-filter:saturate(180%) blur(6px)}
  h1{margin:0;font-size:20px;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
  .logo-bot svg{width:24px;height:24px;vertical-align:middle;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}

  /* layout (hidden until after landing) */
  .layout{max-width:1280px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  aside{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;min-height:72vh;display:flex;flex-direction:column}
  .main{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;flex-direction:column}
  .hidden{display:none}

  /* sidebar */
  .status{margin-bottom:10px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#0e1734;color:#bcd;font-size:13px}
  .status.ok{color:#9ff3c8;border-color:#2a5}
  .status.err{color:#ffd1d1;border-color:#a33;background:#2a0e14}
  .inputs{display:grid;grid-template-columns:1fr 130px;gap:8px}
  .inputs > div{min-width:0}
  label{display:block;margin:4px 0 4px;color:var(--muted);font-weight:600}
  input,select,button{background:#0e1630;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:9px 10px}
  input,select{width:100%}
  #username{font-size:16px}
  button{cursor:pointer;transition:.2s;white-space:nowrap}
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .row-2{display:grid;grid-template-columns:1fr 110px;gap:8px;margin-top:6px}
  .nav-head{font-size:12px;color:#8fa1ff99;margin:12px 0 6px}
  .league-list{display:flex;flex-direction:column;gap:6px;overflow:auto}
  .league-item, .summary-item{display:flex;gap:8px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:#0e1734;cursor:pointer}
  .league-item.active, .summary-item.active{outline:2px solid var(--accent)}
  .li-title{font-weight:600}
  .li-sub{font-size:12px;color:#8fa1ff99}

  /* main controls */
  .controls{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
  .controls .group{min-width:160px}

  /* tabs + sections */
  .tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .tab-btn{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#0e1630}
  .tab-btn.active{outline:2px solid var(--accent);color:#000;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .sections > section{display:none;margin-top:12px}
  .sections > section.active{display:block}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  /* tables */
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;background:#0b122a;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border)}
  th{background:#10183a;text-align:left;color:#b8c6ff}
  tr:last-child td{border-bottom:none}
  th.sortable{cursor:pointer; user-select:none; position:relative}
  th.sortable .arrow{font-size:11px; margin-left:6px; opacity:.65}
  th.sorted-asc .arrow, th.sorted-desc .arrow{opacity:1; color:var(--accent)}

  .note{color:#8fa1ff88;font-size:13px;margin-top:8px}
  footer{color:#8fa1ff55;font-size:12px;margin:16px 0 8px}

  /* full-screen landing */
  .landing{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:24px;
    background:linear-gradient(180deg,#0b1020,#0a0f1f 60%);
    z-index:9999;
  }
  .landing-card{
    display:flex; flex-direction:column; align-items:center; gap:18px; max-width:720px; text-align:center;
  }
  .landing .bot svg{width:160px;height:160px;filter:drop-shadow(0 8px 24px rgba(0,0,0,.35))}
  .bubble{background:#0e1734; border:1px solid var(--border); border-radius:14px; padding:16px 18px; color:#c9d3ffcc}
  .bubble .hi{font-weight:800; color:#e8ecff; margin-bottom:6px}
  .landing .entry{display:flex; gap:8px; width:min(560px,90vw)}
  .landing input{flex:1}
  .muted-mini{font-size:12px; color:#8fa1ff99}
</style>
</head>
<body>
<header>
  <h1>
    <span class="logo-bot" aria-hidden="true">
      <!-- tiny header robot -->
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img">
        <defs><linearGradient id="gh" x1="0" x2="1"><stop offset="0" stop-color="#5ee0ff"/><stop offset="1" stop-color="#84ffb5"/></linearGradient></defs>
        <circle cx="60" cy="14" r="6" fill="url(#gh)"/><rect x="58" y="20" width="4" height="8" rx="2" fill="#5ee0ff"/>
        <rect x="28" y="30" width="64" height="40" rx="10" fill="#0f1a3a" stroke="#2a3a72"/>
        <circle cx="46" cy="48" r="6" fill="#5ee0ff"/><circle cx="74" cy="48" r="6" fill="#5ee0ff"/>
        <rect x="44" y="60" width="32" height="3" rx="1.5" fill="#24346b"/>
        <rect x="34" y="74" width="52" height="28" rx="8" fill="#0f1a3a" stroke="#2a3a72"/>
      </svg>
    </span>
    My Fantasy Agent
  </h1>
</header>

<!-- Full-screen landing (shown first) -->
<div id="landing" class="landing">
  <div class="landing-card">
    <div class="bot" aria-hidden="true">
      <!-- big robot -->
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img">
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#5ee0ff"/><stop offset="1" stop-color="#84ffb5"/></linearGradient></defs>
        <circle cx="60" cy="14" r="8" fill="url(#g)"/><rect x="58" y="24" width="4" height="10" rx="2" fill="#5ee0ff"/>
        <rect x="22" y="36" width="76" height="46" rx="12" fill="#0f1a3a" stroke="#2a3a72" stroke-width="2"/>
        <circle cx="44" cy="58" r="7" fill="#5ee0ff"/><circle cx="76" cy="58" r="7" fill="#5ee0ff"/>
        <rect x="42" y="72" width="36" height="4" rx="2" fill="#24346b"/>
        <rect x="32" y="86" width="56" height="26" rx="10" fill="#0f1a3a" stroke="#2a3a72" stroke-width="1.5"/>
      </svg>
    </div>
    <div class="bubble">
      <div class="hi">Hi, I’m your personal fantasy football agent 🤖</div>
      <div>Enter your <b>Sleeper Username</b> below to see everything about your leagues. Let’s get some Ws!</div>
    </div>
    <div class="entry">
      <input id="landingUsername" placeholder="Sleeper Username" />
      <button id="landingGo" disabled>Continue</button>
    </div>
    <div class="muted-mini">We’ll fetch your leagues once you continue.</div>
  </div>
</div>

<!-- Main app (hidden until username entered) -->
<div id="appLayout" class="layout hidden">
  <aside>
    <div id="status" class="status">Enter your Sleeper username, choose a season (center), and click <b>View Leagues</b>.</div>

    <!-- Username + View -->
    <div class="inputs">
      <div>
        <label for="username">Sleeper Username</label>
        <input id="username" placeholder="" />
      </div>
      <div style="align-self:end; display:flex; gap:8px; justify-content:flex-end">
        <button id="viewLeaguesBtn" disabled>View Leagues</button>
      </div>
    </div>

    <!-- Optional: add a specific league -->
    <div class="row-2">
      <input id="manualLeagueId" placeholder="League ID (optional)" />
      <button id="addLeagueBtn" disabled>Add</button>
    </div>

    <div class="nav-head">Overview</div>
    <div id="summaryItem" class="summary-item hidden">
      <div>
        <div class="li-title">User Summary</div>
        <div class="li-sub">Cross-league view</div>
      </div>
    </div>

    <div class="nav-head">Your Leagues</div>
    <div id="leagueList" class="league-list"></div>
  </aside>

  <div class="main">
    <!-- center controls -->
    <div class="controls">
      <div class="group" style="min-width:260px">
        <div class="note" id="contextNote"></div>
      </div>
      <div class="group hidden" id="seasonGroup">
        <label for="seasonMain">Season</label>
        <select id="seasonMain">
          <option value="2025" selected>2025</option>
          <option value="2024">2024</option>
        </select>
      </div>
      <div class="group hidden" id="weekGroup">
        <label for="weekSelect">Week</label>
        <select id="weekSelect"></select>
      </div>
    </div>

    <!-- USER SUMMARY -->
    <div id="userSummary" class="hidden">
      <div class="tabs" id="usTabs">
        <button class="tab-btn active" data-tab="us-root">Who to Root For</button>
        <button class="tab-btn" data-tab="us-proj">Projections</button>
        <button class="tab-btn" data-tab="us-byes">Bye Count</button>
      </div>
      <div class="sections">
        <section id="us-root" class="active"><div id="usRootTable"></div></section>
        <section id="us-proj"><div id="usProjTable"></div></section>
        <section id="us-byes"><div id="usByeTable"></div></section>
      </div>
    </div>

    <!-- LEAGUE VIEWS -->
    <div id="leagueViews" class="hidden">
      <div class="tabs" id="leagueTabs">
        <button class="tab-btn active" data-tab="tab-roster">My Roster</button>
        <button class="tab-btn" data-tab="tab-pos">Team Projections</button>
        <button class="tab-btn" data-tab="tab-matchup">Opponent Projections</button>
        <button class="tab-btn" data-tab="tab-byes">Bye Week Matrix</button>
      </div>
      <div class="sections" id="leagueSections">
        <section id="tab-roster" class="active"><div id="rosterTable"></div></section>
        <section id="tab-pos"><div id="posTable"></div></section>
        <section id="tab-matchup">
          <div id="matchupSummary"></div>
          <div class="row" style="margin-top:8px">
            <div id="myStarters"></div>
            <div id="oppStarters"></div>
          </div>
        </section>
        <section id="tab-byes"><div id="byeMatrix"></div></section>
      </div>
    </div>

    <footer>Uses public Sleeper API + Rotowire projections via Sleeper. Data cached for ~3h in localStorage.</footer>
  </div>
</div>

<script>
/* ===== DOM helpers & cache ===== */
const $ = s => document.querySelector(s);
const el = (tag, attrs={}, kids=[]) => { const n=document.createElement(tag); for (const [k,v] of Object.entries(attrs)){ k==='class'? n.className=v : k==='html'? n.innerHTML=v : n.setAttribute(k,v); } (Array.isArray(kids)?kids:[kids]).filter(Boolean).forEach(k=>n.append(k)); return n; };
const TTL = 3*3600*1000; const ck = u=>'cache:'+u;
async function fetchJSON(url){
  const now=Date.now(); try{ const c=localStorage.getItem(ck(url)); if(c){ const {ts,data}=JSON.parse(c); if(now-ts<TTL) return data; } }catch{}
  const r = await fetch(url); if(!r.ok) throw new Error(`${r.status} for ${url}`);
  const data = await r.json(); try{ localStorage.setItem(ck(url), JSON.stringify({ts:now,data})) }catch{}; return data;
}

/* ===== Sleeper fetches ===== */
async function resolveUserId(usernameOrId){
  try{
    if(/^\d+$/.test(usernameOrId)) return usernameOrId;
    const u = await fetchJSON(`https://api.sleeper.app/v1/user/${encodeURIComponent(usernameOrId)}`);
    return u?.user_id || null;
  }catch{ return null }
}
async function loadMyLeagues(userId, season){
  return await fetchJSON(`https://api.sleeper.app/v1/user/${userId}/leagues/nfl/${season}`);
}
async function loadLeagueBundle(leagueId){
  const league  = await fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}`);
  const users   = await fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}/users`);
  const rosters = await fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}/rosters`);
  return {league, users, rosters};
}
async function loadPlayersMap(){ return await fetchJSON(`https://api.sleeper.app/v1/players/nfl`); }

/* ===== Projections (Rotowire) ===== */
const PROVIDER='rotowire';
function feedPPR(it){ const ks=['ppr','pts_ppr','fantasy_points_ppr']; for(const k of ks){ if(it?.[k]!=null) return +it[k]||0 } const s=it?.stats||{}; for(const k of ks){ if(s?.[k]!=null) return +s[k]||0 } return 0 }
async function providerRows(season, week, season_type){
  const url=`https://api.sleeper.app/projections/nfl/${season}/${week}?season_type=${season_type}&position[]=QB&position[]=RB&position[]=WR&position[]=TE&order_by=ppr`;
  const raw = await fetchJSON(url); const rows={};
  if(Array.isArray(raw)){ for(const it of raw){ if((it.company||'').toLowerCase()!==PROVIDER) continue; const pid=String(it.player_id||it.player||''); if(!pid) continue; const best=rows[pid]; if(!best||feedPPR(it)>feedPPR(best)) rows[pid]=it; } }
  return rows;
}
function rescored(pid, rowsByPid, players, scoring){
  const meta=players[pid]||{}; const pos=meta.position||'UNK'; const st=(rowsByPid[pid]||{}).stats||{}; const v=k=> +((st?.[k])||0);
  const sc=scoring||{}; let pts=0;
  pts += v('pass_yd')*(sc.pass_yd||0)+v('pass_td')*(sc.pass_td||0)+v('pass_int')*(sc.pass_int||0)+v('pass_2pt')*(sc.pass_2pt||0);
  pts += v('rush_yd')*(sc.rush_yd||0)+v('rush_td')*(sc.rush_td||0)+v('rush_2pt')*(sc.rush_2pt||0);
  const rec=v('rec'); pts += rec*(sc.rec||0)+v('rec_yd')*(sc.rec_yd||0)+v('rec_td')*(sc.rec_td||0)+v('rec_2pt')*(sc.rec_2pt||0);
  pts += v('fum_lost')*(sc.fum_lost||0); if(pos==='TE') pts += rec*(sc.bonus_rec_te||0);
  return +pts.toFixed(2);
}
async function projByPid(season, week, season_type, players, scoring){
  const rows=await providerRows(season, week, season_type); const out={}; Object.keys(rows).forEach(pid=> out[pid]=rescored(pid,rows,players,scoring)); return out;
}

/* ===== Helpers ===== */
function rosterPids(roster){ const s=new Set([...(roster.players||[]), ...(roster.starters||[]), ...(roster.taxi||[])]); s.delete('0'); return [...s]; }
function rosterRows(roster, players, projFn){
  return rosterPids(roster).map(pid=>{ const m=players[pid]||{}; const name=m.full_name||(m.first_name&&m.last_name?`${m.first_name} ${m.last_name}`:(m.last_name||'Unknown')); return {pid, name, pos:(m.position||'UNK').toUpperCase(), team:m.team||'FA', proj:projFn? +projFn(pid)||0 : null, bye:m.bye_week}; });
}
function selectBest(rows, set, k){ const pool=rows.filter(r=>set.has(r.pos)).sort((a,b)=>b.proj-a.proj); const picks=pool.slice(0,k); const ids=new Set(picks.map(p=>p.pid)); return {picks, remaining: rows.filter(r=>!ids.has(r.pid))}; }
function teamPosValues(league, rows){
  const rp=(league.roster_positions||[]).map(x=>String(x).toUpperCase());
  const PURE={QB:rp.filter(x=>x==='QB').length, RB:rp.filter(x=>x==='RB').length, WR:rp.filter(x=>x==='WR').length, TE:rp.filter(x=>x==='TE').length};
  const FLEX=rp.filter(x=>x==='FLEX').length, SFLEX=rp.filter(x=>x==='SUPER_FLEX').length;
  let remaining=rows.slice(), values={};
  for(const [pos,k] of Object.entries(PURE)){ const {picks,remaining:rem}=selectBest(remaining,new Set([pos]),k); remaining=rem; values[pos]=picks.reduce((s,p)=>s+p.proj,0); }
  if(FLEX){ const {picks,remaining:rem}=selectBest(remaining,new Set(['RB','WR','TE']),FLEX); remaining=rem; values.FLEX=picks.reduce((s,p)=>s+p.proj,0);} else values.FLEX=0;
  if(SFLEX){ const {picks,remaining:rem}=selectBest(remaining,new Set(['QB','RB','WR','TE']),SFLEX); remaining=rem; values.SUPER_FLEX=picks.reduce((s,p)=>s+p.proj,0);} else values.SUPER_FLEX=0;
  return values;
}
function rankPct(vals, mine){ const sv=[...vals].sort((a,b)=>b-a); const rank=sv.indexOf(mine)+1; const n=sv.length; const below=sv.filter(v=>v<mine).length; return {rank,out_of:n,pct:Math.round(1000*below/n)/10}; }
function parseBD(meta){ for(const k of ['birth_date','birthdate','birthDate']){ const raw=meta?.[k]; if(!raw) continue; const d=new Date(String(raw).slice(0,10)); if(!isNaN(d)) return d; } return null }
function ageFrom(d){ const now=new Date(); let a=now.getFullYear()-d.getFullYear(); const m=now.getMonth()-d.getMonth(); if(m<0||(m===0&&now.getDate()<d.getDate())) a--; return a }
function age(meta){ if(meta?.age!=null){ const n=+meta.age; if(Number.isFinite(n)&&n>0) return Math.floor(n) } const bd=parseBD(meta); return bd? ageFrom(bd):null }
const BYE_2025={ATL:5,CHI:5,GB:5,PIT:5,HOU:6,MIN:6,BAL:7,BUF:7,ARI:8,DET:8,JAX:8,LV:8,LAR:8,SEA:8,CLE:9,NYJ:9,PHI:9,TB:9,CIN:10,DAL:10,KC:10,TEN:10,IND:11,NO:11,DEN:12,LAC:12,MIA:12,WAS:12,CAR:14,NE:14,NYG:14,SF:14};
function teamBye(team, season){ return season==2025 ? BYE_2025[team] : null }

/* ===== Tables ===== */
function renderStatus(kind, msg){ const s=$('#status'); s.className='status '+(kind||''); s.innerHTML=msg; }
function renderTable(container, headers, rows){
  const table=el('table'), thead=el('thead'), tbody=el('tbody');
  thead.append(el('tr',{}, headers.map(h=>el('th',{html:h}))));
  rows.forEach(r=>tbody.append(el('tr',{}, r.map(c=>el('td',{html:String(c)})))));
  table.append(thead,tbody); container.innerHTML=''; container.append(table);
}
function renderSortableTable(container, headers, rows, types){
  const table=el('table'), thead=el('thead'), tbody=el('tbody');
  let sortCol=-1, sortDir='desc';
  const parse=(v,t)=> t==='num'? (Number.isNaN(+v)?null:+v) : t==='bye'? (v && String(v).startsWith('W') ? +String(v).slice(1) : (Number.isNaN(+v)?null:+v)) : String(v||'');
  const cmp=(a,b,t,d)=>{ const mul=d==='asc'?1:-1; if(t==='str') return mul*String(a).localeCompare(String(b)); if(a==null&&b==null) return 0; if(a==null) return 1; if(b==null) return -1; return mul*(a-b); };
  function head(){ const tr=el('tr'); headers.forEach((h,i)=>{ const th=el('th'); th.classList.add('sortable'); th.append(el('span',{html:h}), el('span',{class:'arrow',html:''})); th.addEventListener('click',()=>{ if(sortCol===i){sortDir=sortDir==='asc'?'desc':'asc'} else {sortCol=i; sortDir='desc'}; body(); arrows(); }); tr.append(th); }); thead.innerHTML=''; thead.append(tr); }
  function arrows(){ thead.querySelectorAll('th').forEach((th,i)=>{ th.classList.remove('sorted-asc','sorted-desc'); const a=th.querySelector('.arrow'); if(!a) return; if(i===sortCol){ th.classList.add(sortDir==='asc'?'sorted-asc':'sorted-desc'); a.textContent=sortDir==='asc'?'▲':'▼'; } else a.textContent=''; }); }
  function body(){ const t=rows.map(r=>({raw:r,key:r.map((c,idx)=>parse(c,types[idx]))})); if(sortCol>=0) t.sort((ra,rb)=>cmp(ra.key[sortCol], rb.key[sortCol], types[sortCol], sortDir)); tbody.innerHTML=''; t.forEach(r=>tbody.append(el('tr',{}, r.raw.map(c=>el('td',{html:String(c)}))))); }
  head(); body(); arrows(); table.append(thead,tbody); container.innerHTML=''; container.append(table);
}

/* ===== Per-league views ===== */
function renderRoster(container, roster, players, season){
  const rows = rosterRows(roster, players).map(r=>{
    const m=players[r.pid]||{}; const a=age(m); const ageDisp=Number.isInteger(a)?a:'—';
    let bye=teamBye(r.team, season); if(!(Number.isInteger(bye)&&bye>=1&&bye<=18)) bye = Number.isInteger(r.bye)? r.bye : null;
    const byeDisp=Number.isInteger(bye)? 'W'+bye : '—';
    return [r.name, r.pos, r.team, ageDisp, byeDisp];
  });
  renderSortableTable(container, ['Player','Pos','Team','Age','Bye'], rows, ['str','str','str','num','bye']);
}
function renderPos(container, posStats){
  const order=['QB','RB','WR','TE','FLEX','SUPER_FLEX']; const rows=[];
  for(const pos of order){ const s=posStats[pos]; if(!s) continue; rows.push([pos, s.my_value.toFixed(2), `${s.rank} / ${s.out_of}`, `${s.percentile}%`]); }
  renderTable(container, ['Pos','Points','Rank','Percentile'], rows);
}
function renderMatchup(sumDiv, myDiv, oppDiv, p){
  renderTable(sumDiv, ['Team','Projected Total'], [[p.me.team_name||'Me', p.me.projected_total],[p.opponent.team_name||'Opponent', p.opponent.projected_total]]);
  renderTable(myDiv, ['My Starters','Pos','Team','Proj'], p.myStart.map(x=>[x.name,x.pos,x.team,x.proj.toFixed(2)]));
  renderTable(oppDiv,['Opponent Starters','Pos','Team','Proj'], p.oppStart.map(x=>[x.name,x.pos,x.team,x.proj.toFixed(2)]));
}
async function matchupPreview(leagueId, week, league, users, rosters, players, projFn, myRid, myTeam){
  let matchups=[]; try{ matchups=await fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}/matchups/${week}`) }catch{}
  const byRid=new Map(matchups.filter(m=>m&&typeof m==='object').map(m=>[m.roster_id,m]));
  const myM=byRid.get(myRid);
  const userById=Object.fromEntries(users.map(u=>[u.user_id,u]));
  const rosterById=Object.fromEntries(rosters.map(r=>[r.roster_id,r]));
  const teamName = rid => { const r=rosterById[rid]||{}; const u=userById[r.owner_id]||{}; return (u.metadata?.team_name)||u.display_name||(rid?`Team ${rid}`:null); };
  const starters = rid => { const m=byRid.get(rid)||{}; const r=rosterById[rid]||{}; return (m.starters||r.starters||[]).filter(pid=>pid!=='0'); };
  const startersProj = rid => starters(rid).map(pid=>{ const m=players[pid]||{}; const name=m.full_name||(m.first_name&&m.last_name?`${m.first_name} ${m.last_name}`:(m.last_name||'Unknown')); return {pid,name,pos:(m.position||'UNK').toUpperCase(),team:m.team||'FA',proj:+projFn(pid)||0}; });
  let oppRid=null; if(myM){ const mid=myM.matchup_id; const opp=matchups.find(m=>m.matchup_id===mid && m.roster_id!==myRid); oppRid=opp?.roster_id??null }
  const myStart=startersProj(myRid), oppStart= oppRid? startersProj(oppRid):[];
  return {week, me:{team_name:myTeam, projected_total:+myStart.reduce((s,p)=>s+p.proj,0).toFixed(2)}, opponent:{team_name:teamName(oppRid), projected_total:+oppStart.reduce((s,p)=>s+p.proj,0).toFixed(2)}, myStart, oppStart};
}
function byeMatrix(roster, players, season, weeks=[5,6,7,8,9,10,11,12,13,14]){
  const pids=rosterPids(roster); const set=new Set(), m={};
  for(const pid of pids){ const pl=players[pid]||{}; const pos=(pl.position||'UNK').toUpperCase(); set.add(pos); let b=teamBye(pl.team, season); if(!(Number.isInteger(b)&&b>=1&&b<=18)) b=Number.isInteger(pl.bye_week)?pl.bye_week:null; if(!m[pos]) m[pos]=Object.fromEntries(weeks.map(w=>[w,0])); if(Number.isInteger(b)&&weeks.includes(b)) m[pos][b]++; }
  const order=['QB','RB','WR','TE', ...[...set].filter(p=>!['QB','RB','WR','TE'].includes(p)).sort()]; return {order,weeks,matrix:m};
}
function renderBye(container, {order,weeks,matrix}){ const headers=['Pos',...weeks.map(w=>'W'+w),'Total'], rows=[]; let col=Array(weeks.length).fill(0); for(const pos of order){ const counts=weeks.map((w,i)=>{ const v=(matrix[pos]||{})[w]||0; col[i]+=v; return v; }); rows.push([pos,...counts, counts.reduce((s,c)=>s+c,0)]);} rows.push(['TOTAL',...col, col.reduce((s,c)=>s+c,0)]); renderTable(container, headers, rows); }

/* ===== USER SUMMARY ===== */
function exposuresAcrossLeagues(leagues, userId, players){
  const counter = new Map();
  for(const {rosters} of Object.values(leagues)){
    const my = rosters.find(r=>r.owner_id===userId); if(!my) continue;
    for(const pid of rosterPids(my)){ counter.set(pid, (counter.get(pid)||0)+1); }
  }
  const rows=[];
  for(const [pid,count] of counter.entries()){
    if(count<2) continue;
    const m=players[pid]||{}; const name=m.full_name||(m.first_name&&m.last_name?`${m.first_name} ${m.last_name}`:(m.last_name||'Unknown'));
    rows.push({pid, name, pos:(m.position||'UNK').toUpperCase(), team:m.team||'FA', count});
  }
  return rows.sort((a,b)=> b.count-a.count || a.name.localeCompare(b.name));
}
async function userSummaryProjections(leagues, players, week){
  const rows=[];
  await Promise.all(Object.values(leagues).map(async entry=>{
    const {league, users, rosters} = entry;
    const season = +league.season; const scoring=league.scoring_settings||{};
    const myRoster = rosters.find(r=>r.owner_id===g.userId); if(!myRoster) return;
    const myUser = users.find(u=>u.user_id===myRoster.owner_id) || {};
    const myTeamName=(myUser.metadata?.team_name)||myUser.display_name||`Team ${myRoster.roster_id}`;
    const proj = await projByPid(season, week, 'regular', players, scoring);
    const projFn = pid => proj[String(pid)]||0;
    const prev = await matchupPreview(league.league_id, week, league, users, rosters, players, projFn, myRoster.roster_id, myTeamName);
    rows.push([league.name, prev.me.projected_total.toFixed(2), prev.opponent.team_name||'—', prev.opponent.projected_total.toFixed(2)]);
  }));
  rows.sort((a,b)=> parseFloat(b[1]) - parseFloat(a[1]));
  return rows;
}
function userSummaryByeCount(leagues, players, season, week){
  const rows=[];
  for(const {league, rosters} of Object.values(leagues)){
    const my = rosters.find(r=>r.owner_id===g.userId); if(!my) continue;
    let total=0;
    for(const pid of rosterPids(my)){
      const m=players[pid]||{}; let b=teamBye(m.team, season); if(!(Number.isInteger(b)&&b>=1&&b<=18)) b=Number.isInteger(m.bye_week)?m.bye_week:null;
      if(b===week) total++;
    }
    rows.push([league.name, total]);
  }
  rows.sort((a,b)=> b[1]-a[1]);
  return rows;
}
async function renderUserSummary(){
  $('#leagueViews').classList.add('hidden');
  $('#userSummary').classList.remove('hidden');
  $('#contextNote').textContent = '';

  const week = +($('#weekSelect').value||1);
  const seasonSel = +($('#seasonMain').value||2025);

  const ex = exposuresAcrossLeagues(g.leagues, g.userId, g.players);
  const rootRows = ex.map(r=>[r.name, r.pos, r.team, r.count]);
  renderSortableTable($('#usRootTable'), ['Player','Pos','Team','Leagues'], rootRows, ['str','str','str','num']);

  $('#usProjTable').innerHTML = '<div class="note">Calculating projections…</div>';
  const projRows = await userSummaryProjections(g.leagues, g.players, week);
  renderTable($('#usProjTable'), ['League','My Proj','Opponent','Opp Proj'], projRows);

  const byeRows = userSummaryByeCount(g.leagues, g.players, seasonSel, week).map(r=>[r[0], r[1]]);
  renderTable($('#usByeTable'), ['League','Players on Bye (W'+week+')'], byeRows);
}

/* ===== App state & wiring ===== */
let g={players:null,userId:null,leagues:{},selected:null, mode:'summary'};

function setWeekOptions(){ const wk=$('#weekSelect'); wk.innerHTML=''; for(let w=1; w<=18; w++){ const o=el('option',{value:String(w),html:'Week '+w}); if(w===1) o.selected=true; wk.append(o); } }
function showControls(){ $('#seasonGroup').classList.remove('hidden'); $('#weekGroup').classList.remove('hidden'); }
function resetMain(){
  $('#leagueViews').classList.add('hidden'); $('#userSummary').classList.add('hidden');
  $('#contextNote').textContent='';
  $('#rosterTable').innerHTML=''; $('#posTable').innerHTML=''; $('#matchupSummary').innerHTML=''; $('#myStarters').innerHTML=''; $('#oppStarters').innerHTML=''; $('#byeMatrix').innerHTML='';
  $('#usRootTable').innerHTML=''; $('#usProjTable').innerHTML=''; $('#usByeTable').innerHTML='';
}

/* sidebar */
function renderLeagueList(active=null){
  const list=$('#leagueList'); list.innerHTML='';
  const ids=Object.keys(g.leagues);
  if(ids.length===0){ list.append(el('div',{class:'li-sub',html:'No leagues loaded yet.'})); return; }
  ids.forEach(id=>{
    const {league, users, rosters} = g.leagues[id];
    const myRoster = rosters?.find?.(r=>r.owner_id===g.userId);
    const myUser = users?.find?.(u=>u.user_id===myRoster?.owner_id) || {};
    const myTeamName = (myUser.metadata?.team_name)||myUser.display_name||`Team ${myRoster?.roster_id ?? ''}`;
    const item = el('div',{class:'league-item'+(id===active?' active':''), 'data-id':id},[
      el('div',{},[
        el('div',{class:'li-title', html: league?.name || `League ${id}`}),
        el('div',{class:'li-sub', html: myTeamName || ''})
      ])
    ]);
    item.addEventListener('click', async ()=>{
      g.mode='league'; g.selected=id;
      document.querySelectorAll('.league-item').forEach(n=>n.classList.remove('active'));
      item.classList.add('active'); $('#summaryItem').classList.remove('active');
      await renderSelectedLeague();
    });
    list.append(item);
  });
}

/* render selected league */
async function renderSelectedLeague(){
  const id=g.selected; if(!id) return;
  const {league, users, rosters} = g.leagues[id]; const season=+league.season; const week=+($('#weekSelect').value||1);
  const myRoster = rosters.find(r=>r.owner_id===g.userId) || rosters[0];
  const myUser = users.find(u=>u.user_id===myRoster.owner_id) || {};
  const myTeamName = (myUser.metadata?.team_name)||myUser.display_name||`Team ${myRoster.roster_id}`;

  renderRoster($('#rosterTable'), myRoster, g.players, season);

  const scoring=league.scoring_settings||{}; const proj = await projByPid(season, week, 'regular', g.players, scoring); const projFn = pid => proj[String(pid)]||0;
  const vals= rosters.reduce((acc,r)=>{ acc[r.roster_id]=teamPosValues(league, rosterRows(r,g.players,projFn)); return acc; },{});
  const mine=vals[myRoster.roster_id]; const posStats={}; for(const pos of ['QB','RB','WR','TE','FLEX','SUPER_FLEX']){ const list=rosters.map(r=> vals[r.roster_id][pos]||0 ); const my=list[rosters.findIndex(r=>r.roster_id===myRoster.roster_id)]; const {rank,out_of,pct}=rankPct(list,my); posStats[pos]={my_value:+my.toFixed(2), rank, out_of, percentile:pct}; }
  renderPos($('#posTable'), posStats);

  const prev = await matchupPreview(league.league_id, week, league, users, rosters, g.players, projFn, myRoster.roster_id, myTeamName);
  renderMatchup($('#matchupSummary'), $('#myStarters'), $('#oppStarters'), prev);

  renderBye($('#byeMatrix'), byeMatrix(myRoster, g.players, season));

  $('#userSummary').classList.add('hidden');
  $('#leagueViews').classList.remove('hidden');
  $('#contextNote').textContent = `${league.name} • ${league.season}`;
}

/* ===== Events ===== */
$('#username').addEventListener('input', ()=>{ $('#viewLeaguesBtn').disabled = !$('#username').value.trim(); });
$('#manualLeagueId').addEventListener('input', ()=>{ $('#addLeagueBtn').disabled = !$('#manualLeagueId').value.trim(); });
$('#weekSelect').addEventListener('change', async ()=>{ if(g.mode==='summary') await renderUserSummary(); else await renderSelectedLeague(); });
$('#seasonMain').addEventListener('change', async ()=>{
  if(!g.userId) return;
  renderStatus('', 'Reloading leagues for selected season…');
  try{
    const season=$('#seasonMain').value;
    const leagues = await loadMyLeagues(g.userId, season);
    g.leagues = {};
    await Promise.all(leagues.map(async L => { g.leagues[L.league_id] = await loadLeagueBundle(L.league_id); }));
    renderStatus('ok', `Loaded ${leagues.length} league(s).`);
    renderLeagueList();
    g.mode='summary'; $('#summaryItem').classList.add('active'); await renderUserSummary();
  }catch(e){ console.error(e); renderStatus('err','Failed to reload for that season.'); }
});

$('#viewLeaguesBtn').addEventListener('click', async ()=>{
  resetMain(); renderStatus('', 'Looking up your leagues…');
  try{
    const uname = $('#username').value.trim();
    if(!uname){ renderStatus('err','Please enter a username.'); return; }
    if(!g.players) g.players = await loadPlayersMap();
    const uid = await resolveUserId(uname);
    if(!uid){ renderStatus('err', `Couldn’t find a Sleeper account for “${uname}”.`); return; }
    g.userId = uid;

    const season=$('#seasonMain').value; // default is 2025
    const leagues = await loadMyLeagues(uid, season);
    if(!Array.isArray(leagues) || leagues.length===0){ renderStatus('err', `No leagues found in ${season}.`); $('#leagueList').innerHTML=''; return; }

    g.leagues = {};
    await Promise.all(leagues.map(async L => { g.leagues[L.league_id] = await loadLeagueBundle(L.league_id); }));

    setWeekOptions(); showControls();
    const sm = $('#summaryItem'); sm.classList.remove('hidden'); sm.classList.add('active');
    sm.onclick = async ()=>{ g.mode='summary'; g.selected=null; document.querySelectorAll('.league-item').forEach(n=>n.classList.remove('active')); sm.classList.add('active'); await renderUserSummary(); };

    renderStatus('ok', `Loaded ${leagues.length} league(s).`);
    renderLeagueList();

    g.mode='summary'; await renderUserSummary();
    $('#contextNote').textContent = '';

  }catch(err){
    console.error(err);
    renderStatus('err', `Failed to load leagues.`);
  }
});

$('#addLeagueBtn').addEventListener('click', async ()=>{
  const id=$('#manualLeagueId').value.trim(); if(!id) return;
  try{
    const b = await loadLeagueBundle(id); g.leagues[id]=b; renderLeagueList(g.selected);
    $('#manualLeagueId').value=''; $('#addLeagueBtn').disabled=true; renderStatus('ok','League added. Click it in the list.');
  }catch(e){ console.error(e); renderStatus('err','Could not add that League ID.'); }
});

// League/User tabs
document.addEventListener('click', (e)=>{
  const btn1 = e.target.closest('#leagueTabs .tab-btn');
  if(btn1){ document.querySelectorAll('#leagueTabs .tab-btn').forEach(x=>x.classList.remove('active')); btn1.classList.add('active');
    const id=btn1.dataset.tab; document.querySelectorAll('#leagueSections > section').forEach(s=>s.classList.toggle('active', s.id===id)); return; }
  const btn2 = e.target.closest('#usTabs .tab-btn');
  if(btn2){ document.querySelectorAll('#usTabs .tab-btn').forEach(x=>x.classList.remove('active')); btn2.classList.add('active');
    const id=btn2.dataset.tab; document.querySelectorAll('#userSummary .sections > section').forEach(s=>s.classList.toggle('active', s.id===id)); return; }
});

/* ===== Landing interactions ===== */
const landingInput = $('#landingUsername');
const landingGo = $('#landingGo');
landingInput.addEventListener('input', ()=>{ landingGo.disabled = !landingInput.value.trim(); });
landingInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !landingGo.disabled){ landingGo.click(); } });
landingGo.addEventListener('click', ()=>{
  const uname = landingInput.value.trim(); if(!uname) return;
  // move to main UI
  $('#landing').classList.add('hidden');
  $('#appLayout').classList.remove('hidden');
  // prefill sidebar username + enable button
  $('#username').value = uname;
  $('#viewLeaguesBtn').disabled = false;
  // status hint
  renderStatus('', 'Username set. Choose a season (center) and click "View Leagues" to load.');
});

/* init */
(function init(){
  // Start on landing; app hidden
  document.getElementById('appLayout').classList.add('hidden');
  document.getElementById('landing').classList.remove('hidden');
  // prepare week options for when app becomes visible
  const wk=$('#weekSelect'); if(wk && !wk.children.length){ for(let w=1; w<=18; w++){ const o=el('option',{value:String(w),html:'Week '+w}); if(w===1) o.selected=true; wk.append(o); } }
})();
</script>
</body>
</html>
